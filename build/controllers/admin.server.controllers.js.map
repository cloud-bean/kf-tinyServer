{"version":3,"sources":["../../src/controllers/admin.server.controllers.js"],"names":["webapi","require","request","config","api","co","index","req","res","send","getUserOpenIdByWeb","code","Promise","resolve","reject","getAccessToken","err","result","console","log","data","openid","getUserInfoByOpenId","getUser","authBaseServer","user","post","baseServer","baseRoute","authRoute","providerData","client_id","client_secret","grant_type","then","catch","auth","query","unionid","accessToken","body","access_token","userid","user_id","json","authLocal","getJssdkConfig","url","param","debug","jsApiList","getJsConfig","sendTemplate","content","openId","templateId","uploadImage2Qn","media_id","getMedia","module","exports"],"mappings":"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","file":"admin.server.controllers.js","sourcesContent":["// const getErrorMessage = require('./core/errors.server.controllers').getErrorMessage;\n\n\n// const path = require('path');\nconst webapi = require('../config/wechatAPI').webapi;\nconst request = require('superagent');\nconst config = require('../config/config');\nconst api = require('../config/wechatAPI').api;\n// const fs = require('fs');\nconst co = require('co');\n// const userHelper = require('../helper/userHelper.server');\n\nfunction index(req, res) {\n    res.send('hello world');\n}\n\n// function login(req, res) {\n//   co(function *(){\n//     try {\n//       const username = req.body.username;\n//       const password = req.body.password;\n//       const token = yield authBaseServer(username,password);\n//       res.send(token.body);\n//     } catch (err) {\n//       console.log(err);\n//     }\n//   });\n// }\n// function signUp(req, res) {\n//   const accessToken = req.body.access_token;\n//   const userId = req.body.user_id;\n//   const user\n//\n// }\n// function updateUserInfo(userid, accessToken, userInfo) {\n//   request\n//     .put(`${config.baseServer.baseRoute}api/base/users/${userid}`)\n//     .send(userInfo)\n//     .set('Authorization', `Bearer ${accessToken}`)\n//     .then(result => {\n//       resolve(result.data);\n//     })\n//     .catch(err => {\n//       reject(err);\n//     });\n// }\n\nfunction getUserOpenIdByWeb(code) {\n    return new Promise((resolve, reject) => {\n        webapi.getAccessToken(code, (err, result) => {\n            if (err) {\n                console.log(err);\n                reject(err);\n            }else if(result.data){\n              console.log('result.data',result.data);\n              resolve(result.data.openid);\n            } else {\n              console.log('no result data',result);\n              reject('err');\n            }\n            // var accessToken = result.data.access_token;\n            // var openid = result.data.openid;\n        });\n    });\n}\n\n// 当接收到用户发来的消息时，判断数据库中是否有用户信息，若无，则根据openid从微信服务器获取\nfunction getUserInfoByOpenId(openid) {\n    return new Promise((resolve, reject) => {\n        webapi.getUser(openid, (err, result) => {\n            if (err) reject(err);\n            resolve(result);\n        });\n    });\n}\n\nfunction authBaseServer(user) {\n    return new Promise((resolve, reject) => {\n        request\n            .post(config.baseServer.baseRoute + config.baseServer.authRoute)\n            .send({\n                providerData: user,\n                client_id: 'kf-app',\n                client_secret: 'prometheus',\n                grant_type: 'password',\n            })\n            .then((res) => {\n                resolve(res);\n            })\n            .catch((err) => {\n                reject(err);\n            });\n    });\n}\n\nfunction auth(req, res) {\n    co(function*() {\n        try {\n            const openid = yield getUserOpenIdByWeb(req.query.code);\n            const user = yield getUserInfoByOpenId(openid);\n            const unionid = user.unionid;\n            const result = yield authBaseServer(user);\n            const accessToken = result.body.data.access_token;\n            const userid = result.body.data.user_id;\n            // yield updateUserInfo(userid, accessToken, newuser);\n            res.json({ accessToken, userid, unionid });\n        } catch (err) {\n            console.log(err);\n        }\n    });\n}\n\nfunction authLocal(req, res) {\n    co(function*() {\n        try {\n            const user = { openid: req.query.openid };\n            const result = yield authBaseServer(user);\n            res.json({ accessToken: result.body.data.access_token, userid: result.body.data.user_id, unionid:'1232' });\n        } catch (err) {\n            console.log(err);\n        }\n    });\n}\n\nfunction getJssdkConfig(req, res) {\n    const url = req.body.url;\n    var param = {\n        debug: false,\n        jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'chooseImage', 'previewImage', 'uploadImage', 'downloadImage', 'startRecord', 'stopRecord', 'getLocalImgData', 'playVoice', 'uploadVoice', 'onVoicePlayEnd', 'onVoiceRecordEnd', 'downloadVoice'],\n        url,\n    };\n\n    api.getJsConfig(param, (err, result) => {\n        if (err) {\n            console.log(err);\n        } else {\n            console.log('js_ticket:', result);\n            res.send(result);\n        }\n    });\n}\n\nfunction sendTemplate(req, res) {\n    var content = req.body;\n    console.log('templete content', content);\n    api.sendTemplate(content.openId, content.templateId, content.url, content.data, (err, result) => {\n        if (err) {\n            console.log(err);\n            res.send(err);\n        } else {\n            console.log(result);\n            res.send(result);\n        }\n    });\n}\n\nfunction uploadImage2Qn(req, res) {\n    var media_id = req.body.media_id;\n    api.getMedia(media_id, (err, result, res) => {\n        if (err) {\n            console.log(err);\n        } else {\n            console.log(result);\n            res.send(result);\n        }\n    });\n\n}\n\nmodule.exports = {\n    // login,\n    auth,\n    index,\n    getJssdkConfig,\n    sendTemplate,\n    uploadImage2Qn,\n    authLocal,\n    // signUp,\n};\n"]}