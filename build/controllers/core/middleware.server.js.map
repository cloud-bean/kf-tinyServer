{"version":3,"sources":["../../../src/controllers/core/middleware.server.js"],"names":["mongoose","require","User","model","wechatAPI","getUserInfoMiddleware","message","req","res","next","openid","FromUserName","find","err","result","console","log","reply","length","getUser","userInfo","user","save","err1","module","exports"],"mappings":"AAAA,MAAMA,WAAWC,QAAQ,UAAR,CAAjB;AACA,MAAMC,OAAOF,SAASG,KAAT,CAAe,MAAf,CAAb;AACA,MAAMC,YAAYH,QAAQ,wBAAR,CAAlB;;AAEA,SAASI,qBAAT,CAA+BC,OAA/B,EAAwCC,GAAxC,EAA6CC,GAA7C,EAAkDC,IAAlD,EAAuD;AACrD,QAAMC,SAASJ,QAAQK,YAAvB;AACAT,OAAKU,IAAL,CAAU,EAACF,QAAOA,MAAR,EAAV,EAA2B,UAASG,GAAT,EAAaC,MAAb,EAAoB;AAC7C,QAAGD,GAAH,EAAO;AACLE,cAAQC,GAAR,CAAYH,GAAZ;AACAL,UAAIS,KAAJ,CAAU,SAAV;AACD;AACD,QAAIH,OAAOI,MAAP,KAAkB,CAAtB,EAAyB;AACvBd,gBAAUe,OAAV,CAAkBb,QAAQK,YAA1B,EAAwC,UAASE,GAAT,EAAcO,QAAd,EAAuB;AAC7D,cAAMC,OAAO,IAAInB,IAAJ,CAASkB,QAAT,CAAb;AACAC,aAAKC,IAAL,CAAUC,QAAQ;AAChBhB,cAAIc,IAAJ,GAAWA,IAAX;AACAN,kBAAQC,GAAR,CAAYT,IAAIc,IAAhB;AACAZ;AACD,SAJD;AAKD,OAPD;AAQD,KATD,MASO;AACLF,UAAIc,IAAJ,GAAWP,OAAO,CAAP,CAAX;AACAC,cAAQC,GAAR,CAAYT,IAAIc,IAAhB;AACAZ;AACD;AACF,GAnBD;AAoBD;;AAGDe,OAAOC,OAAP,GAAiB;AACfpB;AADe,CAAjB","file":"middleware.server.js","sourcesContent":["const mongoose = require('mongoose');\nconst User = mongoose.model('User');\nconst wechatAPI = require('../../config/wechatAPI');\n\nfunction getUserInfoMiddleware(message, req, res, next){\n  const openid = message.FromUserName;\n  User.find({openid:openid}, function(err,result){\n    if(err){\n      console.log(err);\n      res.reply('数据库读取有误');\n    }\n    if (result.length === 0) {\n      wechatAPI.getUser(message.FromUserName, function(err, userInfo){\n        const user = new User(userInfo);\n        user.save(err1 => {\n          req.user = user;\n          console.log(req.user);\n          next();\n        })\n      });\n    } else {\n      req.user = result[0];\n      console.log(req.user);\n      next();\n    }\n  })\n}\n\n\nmodule.exports = {\n  getUserInfoMiddleware,\n}\n"]}