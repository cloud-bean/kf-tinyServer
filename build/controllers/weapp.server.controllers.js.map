{"version":3,"sources":["../../src/controllers/weapp.server.controllers.js"],"names":["request","require","config","weappApi","getUserInfo","req","res","data","body","code","appid","appId","secret","weappConfig","find","item","appsecret","get","query","js_code","grant_type","end","err","result","unionid","JSON","parse","text","openid","authBaseServerByUnionId","then","loginData","Object","assign","json","catch","e","console","log","Promise","resolve","reject","post","baseServer","baseRoute","weappAuthRoute","send","providerData","client_id","client_secret","sendTemplate","content","openId","templateId","url","formId","error","module","exports"],"mappings":"AAAA,MAAMA,UAAUC,QAAQ,YAAR,CAAhB;AACA,MAAMC,SAASD,QAAQ,kBAAR,CAAf;AACA,MAAME,WAAWF,QAAQ,qBAAR,EAA+BE,QAAhD;;AAEA,SAASC,WAAT,CAAqBC,GAArB,EAA0BC,GAA1B,EAA+B;AAC7B,UAAMC,OAAOF,IAAIG,IAAjB;AACA,UAAMC,OAAOF,KAAKE,IAAlB;AACA,UAAMC,QAAQH,KAAKI,KAAnB;AACA,UAAMC,SAASV,OAAOW,WAAP,CAAmBC,IAAnB,CAAwBC,QAAQA,KAAKL,KAAL,IAAYA,KAA5C,EAAmDM,SAAlE;AACAhB,YACCiB,GADD,CACK,8CADL,EAECC,KAFD,CAEO,EAAER,KAAF,EAASE,MAAT,EAAiBO,SAASV,IAA1B,EAAgCW,YAAY,oBAA5C,EAFP,EAE2E;AAF3E,KAGCC,GAHD,CAGK,UAASC,GAAT,EAAcC,MAAd,EAAqB;AACxB,cAAMC,UAAUC,KAAKC,KAAL,CAAWH,OAAOI,IAAlB,EAAwBH,OAAxC;AACA,cAAMI,SAASH,KAAKC,KAAL,CAAWH,OAAOI,IAAlB,EAAwBC,MAAvC;;AAEAC,gCAAwBL,OAAxB,EACCM,IADD,CACOC,SAAD,IAAa;AACjB,kBAAMxB,OAAOyB,OAAOC,MAAP,CAAc,EAAd,EAAiBF,UAAUvB,IAA3B,EAAgC,EAACgB,OAAD,EAAhC,EAA0C,EAACI,MAAD,EAA1C,CAAb;AACAtB,gBAAI4B,IAAJ,CAAS3B,IAAT;AACD,SAJD,EAKC4B,KALD,CAKOC,KAAK;AACVC,oBAAQC,GAAR,CAAYF,CAAZ;AACD,SAPD;AAQD,KAfD;AAiBD;;AAED,SAASP,uBAAT,CAAiCL,OAAjC,EAA0C;AACtC,WAAO,IAAIe,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACpCzC,gBACK0C,IADL,CACUxC,OAAOyC,UAAP,CAAkBC,SAAlB,GAA8B1C,OAAOyC,UAAP,CAAkBE,cAD1D,EAEKC,IAFL,CAEU;AACFC,0BAAc,EAACvB,OAAD,EADZ;AAEFwB,uBAAW,QAFT;AAGFC,2BAAe,YAHb;AAIF7B,wBAAY;AAJV,SAFV,EAQKU,IARL,CAQWxB,GAAD,IAAS;AACXkC,oBAAQlC,GAAR;AACH,SAVL,EAWK6B,KAXL,CAWYb,GAAD,IAAS;AACZmB,mBAAOnB,GAAP;AACH,SAbL;AAcH,KAfM,CAAP;AAgBH;;AAED,SAAS4B,YAAT,CAAsB7C,GAAtB,EAA2BC,GAA3B,EAAgC;AAC5B,QAAI6C,UAAU9C,IAAIG,IAAlB;AACA6B,YAAQC,GAAR,CAAY,kBAAZ,EAAgCa,OAAhC;AACAhD,aACC+C,YADD,CACcC,QAAQC,MADtB,EAC8BD,QAAQE,UADtC,EACkDF,QAAQG,GAD1D,EAC+DH,QAAQI,MADvE,EAC+EJ,QAAQ5C,IADvF,EAECuB,IAFD,CAEOvB,IAAD,IAAQ;AACZD,YAAIwC,IAAJ,CAASvC,IAAT;AACD,KAJD,EAKCiD,KALD,CAKQlC,GAAD,IAAO;AACZhB,YAAIwC,IAAJ,CAASxB,GAAT;AACD,KAPD;AAQH;;AAGDmC,OAAOC,OAAP,GAAiB;AACb;AACAtD,eAFa;AAGb8C;;AAHa,CAAjB","file":"weapp.server.controllers.js","sourcesContent":["const request = require('superagent');\nconst config = require('../config/config');\nconst weappApi = require('../config/wechatAPI').weappApi;\n\nfunction getUserInfo(req, res) {\n  const data = req.body;\n  const code = data.code;\n  const appid = data.appId;\n  const secret = config.weappConfig.find(item => item.appid==appid).appsecret;\n  request\n  .get('https://api.weixin.qq.com/sns/jscode2session')\n  .query({ appid, secret, js_code: code, grant_type: 'authorization_code' }) // query string\n  .end(function(err, result){\n    const unionid = JSON.parse(result.text).unionid;\n    const openid = JSON.parse(result.text).openid;\n\n    authBaseServerByUnionId(unionid)\n    .then((loginData)=>{\n      const data = Object.assign({},loginData.body,{unionid},{openid});\n      res.json(data);\n    })\n    .catch(e => {\n      console.log(e);\n    });\n  });\n\n}\n\nfunction authBaseServerByUnionId(unionid) {\n    return new Promise((resolve, reject) => {\n        request\n            .post(config.baseServer.baseRoute + config.baseServer.weappAuthRoute)\n            .send({\n                providerData: {unionid},\n                client_id: 'kf-app',\n                client_secret: 'prometheus',\n                grant_type: 'password',\n            })\n            .then((res) => {\n                resolve(res);\n            })\n            .catch((err) => {\n                reject(err);\n            });\n    });\n}\n\nfunction sendTemplate(req, res) {\n    var content = req.body;\n    console.log('templete content', content);\n    weappApi\n    .sendTemplate(content.openId, content.templateId, content.url, content.formId, content.data)\n    .then((data)=>{\n      res.send(data);\n    })\n    .error((err)=>{\n      res.send(err);\n    })\n}\n\n\nmodule.exports = {\n    // login,\n    getUserInfo,\n    sendTemplate\n\n};\n"]}